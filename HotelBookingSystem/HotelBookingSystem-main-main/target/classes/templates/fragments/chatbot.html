<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="utf-8"/></head>
<body>
<div th:fragment="chatbot">
    <style>
        :root{
            --chatbot-accent:#0f6b42;
            --chatbot-accent-2:#0b5333;
            --chatbot-bg:#f8fafc;
            --chatbot-card:#ffffff;
            --chatbot-text:#0f172a;
            --chatbot-muted:#6b7280;
            --chatbot-shadow:0 18px 50px rgba(9,20,33,0.18);
        }
        .chatbot-wrap{
            position:fixed;
            right:22px;
            bottom:22px;
            z-index:3000;
            font-family:Inter, Arial, Helvetica, sans-serif;
        }
        .chatbot-toggle{
            background:linear-gradient(135deg,var(--chatbot-accent),var(--chatbot-accent-2));
            color:#fff;
            border:none;
            border-radius:999px;
            padding:12px 18px;
            font-weight:700;
            cursor:pointer;
            box-shadow:var(--chatbot-shadow);
            display:flex;
            align-items:center;
            gap:8px;
        }
        .chatbot-panel{
            width:340px;
            max-width:90vw;
            background:var(--chatbot-card);
            border-radius:16px;
            box-shadow:var(--chatbot-shadow);
            margin-bottom:12px;
            overflow:hidden;
            display:none;
        }
        .chatbot-header{
            padding:14px 16px;
            background:linear-gradient(135deg,#e8f5ee,#d9f7e7);
            color:var(--chatbot-text);
            font-weight:700;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .chatbot-body{
            padding:14px;
            background:var(--chatbot-bg);
            max-height:340px;
            overflow:auto;
        }
        .chatbot-msg{
            margin:8px 0;
            padding:10px 12px;
            border-radius:12px;
            font-size:14px;
            line-height:1.45;
            white-space:pre-wrap;
        }
        .chatbot-msg.user{
            background:#dff6eb;
            align-self:flex-end;
        }
        .chatbot-msg.bot{
            background:#ffffff;
            border:1px solid #e5e7eb;
        }
        .chatbot-footer{
            padding:12px;
            display:flex;
            gap:8px;
            background:#fff;
            border-top:1px solid #edf1f5;
        }
        .chatbot-input{
            flex:1;
            border:1px solid #e5e7eb;
            border-radius:10px;
            padding:10px 12px;
            font-size:14px;
            outline:none;
        }
        .chatbot-send{
            background:var(--chatbot-accent);
            color:#fff;
            border:none;
            padding:10px 12px;
            border-radius:10px;
            cursor:pointer;
            font-weight:700;
        }
        .chatbot-note{
            padding:0 14px 12px;
            font-size:12px;
            color:var(--chatbot-muted);
        }
        @media (max-width:600px){
            .chatbot-wrap{right:12px;bottom:12px}
            .chatbot-panel{width:92vw}
        }
    </style>

    <div class="chatbot-wrap" id="chatbotWidget">
        <div class="chatbot-panel" id="chatbotPanel" aria-live="polite">
            <div class="chatbot-header">
                <span>Chatbot h·ªó tr·ª£</span>
                <button type="button" id="chatbotClose" style="background:none;border:none;font-size:18px;cursor:pointer;">√ó</button>
            </div>
            <div class="chatbot-body" id="chatbotMessages">
                <div class="chatbot-msg bot">Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ v·ªÅ ƒë·∫∑t ph√≤ng, gi√° ph√≤ng, ho·∫∑c tr·∫°ng th√°i booking?</div>
            </div>
            <div class="chatbot-footer">
                <input class="chatbot-input" id="chatbotInput" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
                <button class="chatbot-send" id="chatbotSend" type="button">G·ª≠i</button>
            </div>
            <div class="chatbot-note">G·ª£i √Ω: h·ªèi v·ªÅ ph√≤ng tr·ªëng, gi√°, ho·∫∑c booking c·ªßa b·∫°n.</div>
        </div>
        <button class="chatbot-toggle" id="chatbotToggle" type="button">üí¨ Chatbot</button>
    </div>

    <script>
        (function(){
            const panel = document.getElementById('chatbotPanel');
            const toggle = document.getElementById('chatbotToggle');
            const closeBtn = document.getElementById('chatbotClose');
            const input = document.getElementById('chatbotInput');
            const sendBtn = document.getElementById('chatbotSend');
            const messages = document.getElementById('chatbotMessages');

            if (!panel || !toggle || !closeBtn || !input || !sendBtn || !messages) return;

            function append(role, text){
                const div = document.createElement('div');
                div.className = 'chatbot-msg ' + role;
                div.textContent = text;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            function setBusy(isBusy){
                sendBtn.disabled = isBusy;
                input.disabled = isBusy;
                sendBtn.textContent = isBusy ? '...' : 'G·ª≠i';
            }

            async function sendMessage(){
                const text = input.value.trim();
                if (!text) return;
                append('user', text);
                input.value = '';
                setBusy(true);
                append('bot', 'ƒêang tr·∫£ l·ªùi...');
                try{
                    const res = await fetch('/api/chatbot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    });
                    const data = await res.json();
                    messages.lastChild.textContent = data.reply || 'Kh√¥ng c√≥ ph·∫£n h·ªìi.';
                }catch(e){
                    messages.lastChild.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi chatbot. Vui l√≤ng th·ª≠ l·∫°i.';
                }finally{
                    setBusy(false);
                }
            }

            toggle.addEventListener('click', () => {
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            });
            closeBtn.addEventListener('click', () => { panel.style.display = 'none'; });
            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
        })();
    </script>
</div>
</body>
</html>
